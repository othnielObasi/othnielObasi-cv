name: Build & Publish CV PDF

on:
  push:
    branches: [ "main" ]

permissions:
  contents: write   # allow committing the generated PDF

jobs:
  build-pdf:
    runs-on: ubuntu-22.04

    steps:
    - name: 📥 Checkout
      uses: actions/checkout@v4

    # Optional but avoids Puppeteer font warnings
    - name: 🖋️ Install fonts/libs
      run: |
        sudo apt-get update
        sudo apt-get install -y fonts-liberation libasound2 libatk-bridge2.0-0 \
          libgtk-3-0 libxss1 libnss3 libgbm1

    - name: 🛠️ Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: "20"
        cache: "npm"

    - name: 📦 Install deps (incl. puppeteer)
      run: |
        npm ci --ignore-scripts    # if you add a package.json later
        npm install puppeteer --save-dev

    - name: 🖨️ Render HTML → PDF
      run: |
        npx puppeteer pdf index.html \
          --output Othniel_Obasi_CV.pdf \
          --format A4 \
          --margin "20mm 15mm" \
          --no-sandbox

    - name: 🔍 Check for changes
      id: diff
      run: |
        git config --global --add safe.directory "$GITHUB_WORKSPACE"
        git add Othniel_Obasi_CV.pdf
        git diff --cached --quiet || echo "changed=true" >> $GITHUB_OUTPUT

    - name: 🚀 Commit updated PDF
      if: steps.diff.outputs.changed == 'true'
      run: |
        git config --global user.email "actions@github.com"
        git config --global user.name  "GitHub Actions"
        git commit -m "chore: update generated CV PDF [skip-pdf]"
        git push
